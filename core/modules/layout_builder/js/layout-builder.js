/**
* DO NOT EDIT THIS FILE.
* See the following change record for more information,
* https://www.drupal.org/node/2815083
* @preserve
**/

(function ($, _ref) {
  var ajax = _ref.ajax,
      behaviors = _ref.behaviors;

  function getComponentRegion(component) {
    return component.closest('[data-region]');
  }

  function getSection(element) {
    return element.closest('.layout-section');
  }

  function getComponentLayoutDelta(element) {
    return element.closest('[data-layout-delta]').data('layout-delta');
  }

  function getSiblingByDirection(element, direction, selector) {
    if (direction === 'previous') {
      return element.prevAll(selector).first();
    }
    return element.nextAll(selector).first();
  }

  function findMoveToRegion(element, direction) {
    var elementRegion = getComponentRegion(element);
    var moveToRegion = getSiblingByDirection(elementRegion, direction, '[data-region]');
    if (moveToRegion.length === 0) {
      var componentSection = getSection(elementRegion);
      var moveToSection = getSiblingByDirection(componentSection, direction, '.layout-section');
      if (moveToSection.length === 0) {
        return null;
      }
      var sectionRegions = moveToSection.find('[data-region]');
      return direction === 'previous' ? sectionRegions.last() : sectionRegions.first();
    } else {
      return moveToRegion;
    }
  }

  function findRegionMoveToElement(region, element, direction) {
    var moveToElement = void 0;
    if (region[0] === getComponentRegion(element)[0]) {
      if (direction === 'previous') {
        moveToElement = element.prev('[data-layout-block-uuid]');
      } else {
        moveToElement = element.next('[data-layout-block-uuid], .new-block').next('[data-layout-block-uuid], .new-block');
      }
      if (moveToElement.length === 0) {
        var moveToRegion = findMoveToRegion(element, direction);
        if (moveToRegion) {
          return findRegionMoveToElement(moveToRegion, element, direction);
        } else {
          return null;
        }
      }
    } else {
      if (direction === 'next') {
        moveToElement = region.children('[data-layout-block-uuid], .new-block').first();
      } else {
        moveToElement = region.find('.new-block');
      }
    }

    return moveToElement.length === 0 ? null : moveToElement;
  }

  function moveComponent(element, direction) {
    var moveToElement = findRegionMoveToElement(getComponentRegion(element), element, direction);
    if (moveToElement) {
      element.addClass('updating');
      var deltaFrom = getComponentLayoutDelta(element);
      moveToElement.before(element);
      updateComponentPosition(element, deltaFrom, direction);
    }
  }

  function updateComponentPosition(item, deltaFrom) {
    var directionFocus = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'none';

    var itemRegion = item.closest('.layout-builder--layout__region');

    var deltaTo = getComponentLayoutDelta(item);
    ajax({
      progress: { type: 'fullscreen' },
      url: [item.closest('[data-layout-update-url]').data('layout-update-url'), deltaFrom, deltaTo, itemRegion.data('region'), item.data('layout-block-uuid'), directionFocus, item.prev('[data-layout-block-uuid]').data('layout-block-uuid')].filter(function (element) {
        return element !== undefined;
      }).join('/')
    }).execute();
  }

  behaviors.layoutBuilder = {
    attach: function attach(context) {
      $(context).find('.layout-builder--layout__region').sortable({
        items: '> .draggable',
        connectWith: '.layout-builder--layout__region',
        placeholder: 'ui-state-drop',

        update: function update(event, ui) {
          var itemRegion = ui.item.closest('.layout-builder--layout__region');
          if (event.target === itemRegion[0]) {
            var deltaTo = getComponentLayoutDelta(ui.item);

            var deltaFrom = ui.sender ? getComponentLayoutDelta(ui.sender) : deltaTo;
            updateComponentPosition(ui.item, deltaFrom);
          }
        }
      });
      $(context).find('[data-layout-builder-reorder] [data-layout-builder-reorder-direction]').on('click', function (e) {
        var direction = $(e.target).attr('data-layout-builder-reorder-direction');
        moveComponent($(e.target).closest('[data-layout-block-uuid]'), direction);
        e.preventDefault();
      });
      $('#layout-builder').find('[data-layout-builder-reorder-direction="next"]').removeClass('hidden').last().addClass('hidden');
      $('#layout-builder').find('[data-layout-builder-reorder-direction="previous"]').removeClass('hidden').first().addClass('hidden');
    }
  };
})(jQuery, Drupal);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxheW91dC1idWlsZGVyLmVzNi5qcyJdLCJuYW1lcyI6WyIkIiwiYWpheCIsImJlaGF2aW9ycyIsImdldENvbXBvbmVudFJlZ2lvbiIsImNvbXBvbmVudCIsImNsb3Nlc3QiLCJnZXRTZWN0aW9uIiwiZWxlbWVudCIsImdldENvbXBvbmVudExheW91dERlbHRhIiwiZGF0YSIsImdldFNpYmxpbmdCeURpcmVjdGlvbiIsImRpcmVjdGlvbiIsInNlbGVjdG9yIiwicHJldkFsbCIsImZpcnN0IiwibmV4dEFsbCIsImZpbmRNb3ZlVG9SZWdpb24iLCJlbGVtZW50UmVnaW9uIiwibW92ZVRvUmVnaW9uIiwibGVuZ3RoIiwiY29tcG9uZW50U2VjdGlvbiIsIm1vdmVUb1NlY3Rpb24iLCJzZWN0aW9uUmVnaW9ucyIsImZpbmQiLCJsYXN0IiwiZmluZFJlZ2lvbk1vdmVUb0VsZW1lbnQiLCJyZWdpb24iLCJtb3ZlVG9FbGVtZW50IiwicHJldiIsIm5leHQiLCJjaGlsZHJlbiIsIm1vdmVDb21wb25lbnQiLCJhZGRDbGFzcyIsImRlbHRhRnJvbSIsImJlZm9yZSIsInVwZGF0ZUNvbXBvbmVudFBvc2l0aW9uIiwiaXRlbSIsImRpcmVjdGlvbkZvY3VzIiwiaXRlbVJlZ2lvbiIsImRlbHRhVG8iLCJwcm9ncmVzcyIsInR5cGUiLCJ1cmwiLCJmaWx0ZXIiLCJ1bmRlZmluZWQiLCJqb2luIiwiZXhlY3V0ZSIsImxheW91dEJ1aWxkZXIiLCJhdHRhY2giLCJjb250ZXh0Iiwic29ydGFibGUiLCJpdGVtcyIsImNvbm5lY3RXaXRoIiwicGxhY2Vob2xkZXIiLCJ1cGRhdGUiLCJldmVudCIsInVpIiwidGFyZ2V0Iiwic2VuZGVyIiwib24iLCJlIiwiYXR0ciIsInByZXZlbnREZWZhdWx0IiwicmVtb3ZlQ2xhc3MiLCJqUXVlcnkiLCJEcnVwYWwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxDQUFDLFVBQUNBLENBQUQsUUFBNEI7QUFBQSxNQUF0QkMsSUFBc0IsUUFBdEJBLElB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QThHa0IsUUFBOUcsQ0FBdUgsUUFBdkg7QUFDRDtBQWhEdUIsR0FBMUI7QUFrREQsQ0F4TUQsRUF3TUdnQyxNQXhNSCxFQXdNV0MsTUF4TVgiLCJmaWxlIjoibGF5b3V0LWJ1aWxkZXIuZXM2LmpzIiwic291cmNlc0NvbnRlbnQiOlsiKCgkLCB7IGFqYXgsIGJlaGF2aW9ycyB9KSA9PiB7XG4gIC8qKlxuICAgKiBHZXRzIHRoZSByZWdpb24gZm9yIGEgY29tcG9uZW50LlxuICAgKlxuICAgKiBAcGFyYW0ge2pRdWVyeX0gY29tcG9uZW50XG4gICAqICAgVGhlIGNvbXBvbmVudC5cbiAgICogQHJldHVybiB7alF1ZXJ5fVxuICAgKiAgIFRoZSBjb21wb25lbnRzIHJlZ2lvbiBlbGVtZW50LlxuICAgKi9cbiAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50UmVnaW9uKGNvbXBvbmVudCkge1xuICAgIHJldHVybiBjb21wb25lbnQuY2xvc2VzdCgnW2RhdGEtcmVnaW9uXScpO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0U2VjdGlvbihlbGVtZW50KSB7XG4gICAgcmV0dXJuIGVsZW1lbnQuY2xvc2VzdCgnLmxheW91dC1zZWN0aW9uJyk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRDb21wb25lbnRMYXlvdXREZWx0YShlbGVtZW50KSB7XG4gICAgcmV0dXJuIGVsZW1lbnQuY2xvc2VzdCgnW2RhdGEtbGF5b3V0LWRlbHRhXScpLmRhdGEoJ2xheW91dC1kZWx0YScpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIG5leHQgbWF0Y2hpbmcgc2libGluZy5cbiAgICpcbiAgICogQHBhcmFtIHtqUXVlcnl9IGVsZW1lbnRcbiAgICogICBUaGUgZWxlbWVudCB0byBnZXQgdGhlIHNpYmxpbmcgZm9yLlxuICAgKiBAcGFyYW0gZGlyZWN0aW9uXG4gICAqIEBwYXJhbSBzZWxlY3RvclxuICAgKiBAcmV0dXJuIHtqUXVlcnl9XG4gICAqICAgVGhlIHNpYmxpbmcgdGhhdCBtYXRjaCB0aGUgc2VsZWN0b3IuXG4gICAqL1xuICBmdW5jdGlvbiBnZXRTaWJsaW5nQnlEaXJlY3Rpb24oZWxlbWVudCwgZGlyZWN0aW9uLCBzZWxlY3Rvcikge1xuICAgIGlmIChkaXJlY3Rpb24gPT09ICdwcmV2aW91cycpIHtcbiAgICAgIHJldHVybiBlbGVtZW50LnByZXZBbGwoc2VsZWN0b3IpLmZpcnN0KCk7XG4gICAgfVxuICAgIHJldHVybiBlbGVtZW50Lm5leHRBbGwoc2VsZWN0b3IpLmZpcnN0KCk7XG4gIH1cblxuICAvKipcbiAgICogRmluZHMgdGhlIHJlZ2lvbiB0byBtb3ZlIHRvLlxuICAgKlxuICAgKiBAcGFyYW0gZWxlbWVudFxuICAgKiBAcGFyYW0gZGlyZWN0aW9uXG4gICAqIEByZXR1cm5zIHsqfVxuICAgKi9cbiAgZnVuY3Rpb24gZmluZE1vdmVUb1JlZ2lvbihlbGVtZW50LCBkaXJlY3Rpb24pIHtcbiAgICBjb25zdCBlbGVtZW50UmVnaW9uID0gZ2V0Q29tcG9uZW50UmVnaW9uKGVsZW1lbnQpO1xuICAgIGNvbnN0IG1vdmVUb1JlZ2lvbiA9IGdldFNpYmxpbmdCeURpcmVjdGlvbihcbiAgICAgIGVsZW1lbnRSZWdpb24sXG4gICAgICBkaXJlY3Rpb24sXG4gICAgICAnW2RhdGEtcmVnaW9uXScsXG4gICAgKTtcbiAgICBpZiAobW92ZVRvUmVnaW9uLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc3QgY29tcG9uZW50U2VjdGlvbiA9IGdldFNlY3Rpb24oZWxlbWVudFJlZ2lvbik7XG4gICAgICBjb25zdCBtb3ZlVG9TZWN0aW9uID0gZ2V0U2libGluZ0J5RGlyZWN0aW9uKFxuICAgICAgICBjb21wb25lbnRTZWN0aW9uLFxuICAgICAgICBkaXJlY3Rpb24sXG4gICAgICAgICcubGF5b3V0LXNlY3Rpb24nLFxuICAgICAgKTtcbiAgICAgIGlmIChtb3ZlVG9TZWN0aW9uLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHNlY3Rpb25SZWdpb25zID0gbW92ZVRvU2VjdGlvbi5maW5kKCdbZGF0YS1yZWdpb25dJyk7XG4gICAgICByZXR1cm4gZGlyZWN0aW9uID09PSAncHJldmlvdXMnXG4gICAgICAgID8gc2VjdGlvblJlZ2lvbnMubGFzdCgpXG4gICAgICAgIDogc2VjdGlvblJlZ2lvbnMuZmlyc3QoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG1vdmVUb1JlZ2lvbjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRmluZHMgdGhlIGVsZW1lbnRzIHRoZSBlbGVtZW50IHRoZSBjdXJyZW50IGVsZW1lbnQgc2hvdWxkIG1vdmUgdG8uXG4gICAqXG4gICAqIEBwYXJhbSByZWdpb25cbiAgICogQHBhcmFtIGVsZW1lbnRcbiAgICogQHBhcmFtIGRpcmVjdGlvblxuICAgKiBAcmV0dXJucyB7bnVsbH1cbiAgICovXG4gIGZ1bmN0aW9uIGZpbmRSZWdpb25Nb3ZlVG9FbGVtZW50KHJlZ2lvbiwgZWxlbWVudCwgZGlyZWN0aW9uKSB7XG4gICAgbGV0IG1vdmVUb0VsZW1lbnQ7XG4gICAgaWYgKHJlZ2lvblswXSA9PT0gZ2V0Q29tcG9uZW50UmVnaW9uKGVsZW1lbnQpWzBdKSB7XG4gICAgICBpZiAoZGlyZWN0aW9uID09PSAncHJldmlvdXMnKSB7XG4gICAgICAgIG1vdmVUb0VsZW1lbnQgPSBlbGVtZW50LnByZXYoJ1tkYXRhLWxheW91dC1ibG9jay11dWlkXScpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbW92ZVRvRWxlbWVudCA9IGVsZW1lbnRcbiAgICAgICAgICAubmV4dCgnW2RhdGEtbGF5b3V0LWJsb2NrLXV1aWRdLCAubmV3LWJsb2NrJylcbiAgICAgICAgICAubmV4dCgnW2RhdGEtbGF5b3V0LWJsb2NrLXV1aWRdLCAubmV3LWJsb2NrJyk7XG4gICAgICB9XG4gICAgICBpZiAobW92ZVRvRWxlbWVudC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgY29uc3QgbW92ZVRvUmVnaW9uID0gZmluZE1vdmVUb1JlZ2lvbihlbGVtZW50LCBkaXJlY3Rpb24pO1xuICAgICAgICBpZiAobW92ZVRvUmVnaW9uKSB7XG4gICAgICAgICAgcmV0dXJuIGZpbmRSZWdpb25Nb3ZlVG9FbGVtZW50KG1vdmVUb1JlZ2lvbiwgZWxlbWVudCwgZGlyZWN0aW9uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZGlyZWN0aW9uID09PSAnbmV4dCcpIHtcbiAgICAgICAgbW92ZVRvRWxlbWVudCA9IHJlZ2lvblxuICAgICAgICAgIC5jaGlsZHJlbignW2RhdGEtbGF5b3V0LWJsb2NrLXV1aWRdLCAubmV3LWJsb2NrJylcbiAgICAgICAgICAuZmlyc3QoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1vdmVUb0VsZW1lbnQgPSByZWdpb24uZmluZCgnLm5ldy1ibG9jaycpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBtb3ZlVG9FbGVtZW50Lmxlbmd0aCA9PT0gMCA/IG51bGwgOiBtb3ZlVG9FbGVtZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIE1vdmUgdGhlIGNvbXBvbmVudCBpbiBhIGRpcmVjdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIGVsZW1lbnRcbiAgICogQHBhcmFtIGRpcmVjdGlvblxuICAgKi9cbiAgZnVuY3Rpb24gbW92ZUNvbXBvbmVudChlbGVtZW50LCBkaXJlY3Rpb24pIHtcbiAgICBjb25zdCBtb3ZlVG9FbGVtZW50ID0gZmluZFJlZ2lvbk1vdmVUb0VsZW1lbnQoXG4gICAgICBnZXRDb21wb25lbnRSZWdpb24oZWxlbWVudCksXG4gICAgICBlbGVtZW50LFxuICAgICAgZGlyZWN0aW9uLFxuICAgICk7XG4gICAgaWYgKG1vdmVUb0VsZW1lbnQpIHtcbiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3VwZGF0aW5nJyk7XG4gICAgICBjb25zdCBkZWx0YUZyb20gPSBnZXRDb21wb25lbnRMYXlvdXREZWx0YShlbGVtZW50KTtcbiAgICAgIG1vdmVUb0VsZW1lbnQuYmVmb3JlKGVsZW1lbnQpO1xuICAgICAgdXBkYXRlQ29tcG9uZW50UG9zaXRpb24oZWxlbWVudCwgZGVsdGFGcm9tLCBkaXJlY3Rpb24pO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudFBvc2l0aW9uKGl0ZW0sIGRlbHRhRnJvbSwgZGlyZWN0aW9uRm9jdXMgPSAnbm9uZScpIHtcbiAgICBjb25zdCBpdGVtUmVnaW9uID0gaXRlbS5jbG9zZXN0KCcubGF5b3V0LWJ1aWxkZXItLWxheW91dF9fcmVnaW9uJyk7XG4gICAgLy8gRmluZCB0aGUgZGVzdGluYXRpb24gZGVsdGEuXG4gICAgY29uc3QgZGVsdGFUbyA9IGdldENvbXBvbmVudExheW91dERlbHRhKGl0ZW0pO1xuICAgIGFqYXgoe1xuICAgICAgcHJvZ3Jlc3M6IHsgdHlwZTogJ2Z1bGxzY3JlZW4nIH0sXG4gICAgICB1cmw6IFtcbiAgICAgICAgaXRlbS5jbG9zZXN0KCdbZGF0YS1sYXlvdXQtdXBkYXRlLXVybF0nKS5kYXRhKCdsYXlvdXQtdXBkYXRlLXVybCcpLFxuICAgICAgICBkZWx0YUZyb20sXG4gICAgICAgIGRlbHRhVG8sXG4gICAgICAgIGl0ZW1SZWdpb24uZGF0YSgncmVnaW9uJyksXG4gICAgICAgIGl0ZW0uZGF0YSgnbGF5b3V0LWJsb2NrLXV1aWQnKSxcbiAgICAgICAgZGlyZWN0aW9uRm9jdXMsXG4gICAgICAgIGl0ZW0ucHJldignW2RhdGEtbGF5b3V0LWJsb2NrLXV1aWRdJykuZGF0YSgnbGF5b3V0LWJsb2NrLXV1aWQnKSxcbiAgICAgIF1cbiAgICAgICAgLmZpbHRlcihlbGVtZW50ID0+IGVsZW1lbnQgIT09IHVuZGVmaW5lZClcbiAgICAgICAgLmpvaW4oJy8nKSxcbiAgICB9KS5leGVjdXRlKCk7XG4gIH1cblxuICBiZWhhdmlvcnMubGF5b3V0QnVpbGRlciA9IHtcbiAgICBhdHRhY2goY29udGV4dCkge1xuICAgICAgJChjb250ZXh0KVxuICAgICAgICAuZmluZCgnLmxheW91dC1idWlsZGVyLS1sYXlvdXRfX3JlZ2lvbicpXG4gICAgICAgIC5zb3J0YWJsZSh7XG4gICAgICAgICAgaXRlbXM6ICc+IC5kcmFnZ2FibGUnLFxuICAgICAgICAgIGNvbm5lY3RXaXRoOiAnLmxheW91dC1idWlsZGVyLS1sYXlvdXRfX3JlZ2lvbicsXG4gICAgICAgICAgcGxhY2Vob2xkZXI6ICd1aS1zdGF0ZS1kcm9wJyxcblxuICAgICAgICAgIC8qKlxuICAgICAgICAgICAqIFVwZGF0ZXMgdGhlIGxheW91dCB3aXRoIHRoZSBuZXcgcG9zaXRpb24gb2YgdGhlIGJsb2NrLlxuICAgICAgICAgICAqXG4gICAgICAgICAgICogQHBhcmFtIHtqUXVlcnkuRXZlbnR9IGV2ZW50XG4gICAgICAgICAgICogICBUaGUgalF1ZXJ5IEV2ZW50IG9iamVjdC5cbiAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdWlcbiAgICAgICAgICAgKiAgIEFuIG9iamVjdCBjb250YWluaW5nIGluZm9ybWF0aW9uIGFib3V0IHRoZSBpdGVtIGJlaW5nIHNvcnRlZC5cbiAgICAgICAgICAgKi9cbiAgICAgICAgICB1cGRhdGUoZXZlbnQsIHVpKSB7XG4gICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcmVnaW9uIGZyb20gdGhlIGV2ZW50IGFuZCByZWdpb24gZm9yIHRoZSBpdGVtIG1hdGNoLlxuICAgICAgICAgICAgY29uc3QgaXRlbVJlZ2lvbiA9IHVpLml0ZW0uY2xvc2VzdChcbiAgICAgICAgICAgICAgJy5sYXlvdXQtYnVpbGRlci0tbGF5b3V0X19yZWdpb24nLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmIChldmVudC50YXJnZXQgPT09IGl0ZW1SZWdpb25bMF0pIHtcbiAgICAgICAgICAgICAgY29uc3QgZGVsdGFUbyA9IGdldENvbXBvbmVudExheW91dERlbHRhKHVpLml0ZW0pO1xuICAgICAgICAgICAgICAvLyBJZiB0aGUgYmxvY2sgZGlkbid0IGxlYXZlIHRoZSBvcmlnaW5hbCBkZWx0YSB1c2UgdGhlIGRlc3RpbmF0aW9uLlxuICAgICAgICAgICAgICBjb25zdCBkZWx0YUZyb20gPSB1aS5zZW5kZXJcbiAgICAgICAgICAgICAgICA/IGdldENvbXBvbmVudExheW91dERlbHRhKHVpLnNlbmRlcilcbiAgICAgICAgICAgICAgICA6IGRlbHRhVG87XG4gICAgICAgICAgICAgIHVwZGF0ZUNvbXBvbmVudFBvc2l0aW9uKHVpLml0ZW0sIGRlbHRhRnJvbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAkKGNvbnRleHQpXG4gICAgICAgIC5maW5kKFxuICAgICAgICAgICdbZGF0YS1sYXlvdXQtYnVpbGRlci1yZW9yZGVyXSBbZGF0YS1sYXlvdXQtYnVpbGRlci1yZW9yZGVyLWRpcmVjdGlvbl0nLFxuICAgICAgICApXG4gICAgICAgIC5vbignY2xpY2snLCBlID0+IHtcbiAgICAgICAgICBjb25zdCBkaXJlY3Rpb24gPSAkKGUudGFyZ2V0KS5hdHRyKFxuICAgICAgICAgICAgJ2RhdGEtbGF5b3V0LWJ1aWxkZXItcmVvcmRlci1kaXJlY3Rpb24nLFxuICAgICAgICAgICk7XG4gICAgICAgICAgbW92ZUNvbXBvbmVudChcbiAgICAgICAgICAgICQoZS50YXJnZXQpLmNsb3Nlc3QoJ1tkYXRhLWxheW91dC1ibG9jay11dWlkXScpLFxuICAgICAgICAgICAgZGlyZWN0aW9uLFxuICAgICAgICAgICk7XG4gICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB9KTtcbiAgICAgICQoJyNsYXlvdXQtYnVpbGRlcicpLmZpbmQoJ1tkYXRhLWxheW91dC1idWlsZGVyLXJlb3JkZXItZGlyZWN0aW9uPVwibmV4dFwiXScpLnJlbW92ZUNsYXNzKCdoaWRkZW4nKS5sYXN0KCkuYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgJCgnI2xheW91dC1idWlsZGVyJykuZmluZCgnW2RhdGEtbGF5b3V0LWJ1aWxkZXItcmVvcmRlci1kaXJlY3Rpb249XCJwcmV2aW91c1wiXScpLnJlbW92ZUNsYXNzKCdoaWRkZW4nKS5maXJzdCgpLmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgICB9LFxuICB9O1xufSkoalF1ZXJ5LCBEcnVwYWwpO1xuIl19